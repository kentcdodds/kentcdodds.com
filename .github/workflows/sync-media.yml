name: üñºÔ∏è Sync Cloudflare media

on:
  push:
    branches:
      - main
    paths:
      - 'content/**'
      - 'content/data/media-manifests/**'
      - 'tools/media/**'
      - '.github/workflows/sync-media.yml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run media sync in dry-run mode'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: sync-media-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 24
  BUN_VERSION: 1.3.9

jobs:
  sync:
    runs-on: ubuntu-latest
    name: üì§ Sync changed media files
    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ‚éî Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: üì• Install dependencies
        run: bun install --frozen-lockfile

      - name: ‚úÖ Validate no legacy references
        run: bun run media:scan-legacy-references:strict

      - name: üì§ Sync media manifests and uploads
        run: |
          set -euo pipefail
          args=()
          if [[ "${{ github.event_name }}" == "push" ]]; then
            args+=(--before "${{ github.event.before }}")
            args+=(--after "${{ github.sha }}")
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            args+=(--dry-run)
          fi
          bun run media:sync-cloudflare -- "${args[@]}"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
