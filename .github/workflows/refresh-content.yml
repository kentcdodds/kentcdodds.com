name: ü•¨ Refresh Content
on:
  push:
    branches:
      - main
      - dev

jobs:
  refresh:
    name: ü•¨ Refresh Content
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: '0'

      - name: ‚éî Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: ü•ü Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: üì• Download deps
        run: bun install --frozen-lockfile

      - name: üßæ Resolve worker/environment for branch
        id: target
        shell: bash
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [ "$REF_NAME" = "main" ]; then
            echo "worker_name=kentcdodds-com" >> "$GITHUB_OUTPUT"
            echo "environment=production" >> "$GITHUB_OUTPUT"
          else
            echo "worker_name=kentcdodds-com-development" >> "$GITHUB_OUTPUT"
            echo "environment=development" >> "$GITHUB_OUTPUT"
          fi

      - name: ‚ôªÔ∏è Restore mdx-remote cache
        id: mdx-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: other/content/mdx-remote
          key: mdx-remote-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            mdx-remote-${{ runner.os }}-${{ github.ref_name }}-
            mdx-remote-${{ runner.os }}-main-

      - name: üß± Ensure branch resources
        id: resources
        env:
          WORKER_NAME: ${{ steps.target.outputs.worker_name }}
          TARGET_ENV: ${{ steps.target.outputs.environment }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -euo pipefail
          bun tools/ci/preview-resources.ts ensure --worker-name "$WORKER_NAME" --environment "$TARGET_ENV" --wrangler-config wrangler.jsonc --out-config wrangler-content.generated.jsonc | tee -a "$GITHUB_OUTPUT"

      - name: üìö Publish mdx-remote artifacts
        run: |
          set -euo pipefail
          bun run content:publish-mdx-remote -- \
            --kv-binding MDX_REMOTE_KV \
            --wrangler-config "${{ steps.resources.outputs.wrangler_config }}" \
            --wrangler-env "${{ steps.target.outputs.environment }}" \
            --before "${{ github.event.before }}" \
            --after "${{ github.sha }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: ‚ôªÔ∏è Save mdx-remote cache
        if: ${{ always() }}
        uses: actions/cache/save@v4
        with:
          path: other/content/mdx-remote
          key: mdx-remote-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}

      - name: ü•¨ Refresh Content
        run: bun ./other/refresh-changed-content.js ${{ github.sha }}
        env:
          REFRESH_CACHE_SECRET: ${{ secrets.REFRESH_CACHE_SECRET }}

      - name: üßπ Cleanup generated content config
        if: always()
        run: rm -f wrangler-content.generated.jsonc
