name: âœ… Validate

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: >-
    validate-${{ github.event_name }}-${{ github.event.pull_request.number ||
    github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 24
  BUN_VERSION: 1.3.9

jobs:
  lint:
    runs-on: ubuntu-latest
    name: ğŸ§¹ Lint
    if: >-
      github.event_name != 'pull_request' || github.event.pull_request.draft ==
      false
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6

      - name: â” Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ§¹ Lint
        run: bun run lint

  media-references:
    runs-on: ubuntu-latest
    name: ğŸ–¼ï¸ Media reference scan
    if: >-
      github.event_name != 'pull_request' || github.event.pull_request.draft ==
      false
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6

      - name: â” Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ–¼ï¸ Scan media references
        run: bun run media:scan-legacy-references:strict

  mdx-remote-compile:
    runs-on: ubuntu-latest
    name: ğŸ“š mdx-remote compile dry-run
    if: >-
      github.event_name != 'pull_request' || github.event.pull_request.draft ==
      false
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6

      - name: â” Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ“š Compile mdx-remote docs (dry-run)
        run: bun run content:compile-mdx-remote:dry-run

  typecheck:
    runs-on: ubuntu-latest
    name: ğŸ§ª Typecheck
    if: >-
      github.event_name != 'pull_request' || github.event.pull_request.draft ==
      false
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6

      - name: â” Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ§ª Typecheck
        run: bun run typecheck

  test-backend:
    runs-on: ubuntu-latest
    name: âœ… Backend tests
    if: >-
      github.event_name != 'pull_request' || github.event.pull_request.draft ==
      false
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6

      - name: â” Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: âœ… Run backend tests
        run: bun run test:backend

  build:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build
    if: >-
      github.event_name != 'pull_request' || github.event.pull_request.draft ==
      false
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6

      - name: â” Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ—ï¸ Build
        run: bun run build
